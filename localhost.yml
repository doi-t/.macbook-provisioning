---
- hosts: localhost
  connection: local
  gather_facts: 'no'
  become: 'no'
  vars:
    colon: ':'
    homebrew_taps:
      - homebrew/binary
      - homebrew/dupes
      - caskroom/cask
      - sanemat/font
    homebrew_packages:
      - {name: gcc}
      - {name: readline}
      - {name: openssl}
      - {name: openssl, state: linked, install_options: force}
      - {name: python}
      - {name: ansible}
      - {name: coreutils}
      - {name: lua}
      - {name: neovim}
      - {name: git}
      - {name: zsh, install_options: --without-etcdir}
      - {name: wget}
      - {name: curl}
      - {name: cmake}
      - {name: autoconf}
      - {name: automake}
      - {name: pkg-config}
      - {name: ctags}
      - {name: tree}
      - {name: watch}
      - {name: lv}
      - {name: nkf}
      - {name: htop}
      - {name: direnv}
      - {name: go}
      - {name: ghq}
      - {name: peco}
      - {name: glide}
      - {name: rbenv}
      - {name: rbenv-gemset}
      - {name: ruby-build}
      - {name: libxml2}
      - {name: libxslt}
      - {name: libiconv}
      - {name: w3m}
      - {name: screen}
      - {name: tmux}
      - {name: redis}
      - {name: nginx}
      - {name: source-highlight}
      - {name: jq}
      - {name: httpie}
      - {name: hub}
      - {name: tig}
      - {name: packer}
      - {name: serf}
      - {name: consul}
      - {name: tfenv}
      - {name: vault}
      - {name: nomad}
      - {name: kops}
      - {name: python@2}
      - {name: mpv}
      - {name: stern}
      - {name: iftop}
      - {name: fzf}
      - {name: fd}
      - {name: kubectx}
      - {name: kube-ps1}
      - {name: kubernetes-helm}
      - {name: hugo}
    homebrew_cask_packages:
      - {name: google-chrome}
      - {name: google-japanese-ime}
      - {name: vagrant}
      - {name: chefdk}
      - {name: virtualbox}
      - {name: skype}
      - {name: slack}
      - {name: iterm2}
      - {name: adobe-reader}
      - {name: java}
      - {name: dropbox}
      - {name: minikube}
      - {name: alfred}
      - {name: anki}
      - {name: kindle}
      - {name: karabiner-elements}
      - {name: clipy}
      - {name: 1password}
      - {name: bitbar}
      - {name: spectacle}
      - {name: authy}

  pre_tasks:
    - shell: echo 'mackbook provisioning!'
  tasks:
    # update homebrew
    - name: add tap repositories
      homebrew_tap: tap={{ item }} state=present
      with_items: '{{homebrew_taps}}'

    - name: update homebrew
      homebrew: update_homebrew=yes

    # brew
    - name: install brew packages
      homebrew: >
        name: "{{ item.name }}"
        state: "{{ item.state | default('latest') }}"
        install_options: "{{
          item.install_options | default() | join(',')
          if item.install_options is not string
          else item.install_options
        }}"
      with_items: '{{homebrew_packages}}'
      register: brew_result
    - name: make directory for information of brew packages
      file: path=brew_info state=directory
    - name: save information of brew packages
      shell: brew info {{ item }} > brew_info/{{ item }}
      with_items: "{{brew_result.results | selectattr('changed') | map(attribute='item') | map(attribute='name') | list}}"

    # cask
    - name: install cask packages
      homebrew_cask:
        name: "{{ item.name }}"
        state: "{{ item.state | default('installed') }}"
      with_items: '{{homebrew_cask_packages}}'
      register: cask_result
    - name: make directory for information of cask packages
      file: path=cask_info state=directory
    - name: save information of cask packages
      shell: brew cask info {{ item }} > cask_info/{{ item }}
      with_items: "{{cask_result.results | selectattr('changed') | map(attribute='item') | map(attribute='name') | list}}"
    # tab completion for Mac OS X terminal
    - name: setup tab completion
      shell: cat './inputrc.txt' >> ~/.inputrc
      args:
        creates: ~/.inputrc

    # oh-my-zsh
    - name: install oh-my-zsh
      shell: curl -sL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh | sh
      args:
        creates: ~/.oh-my-zsh/
      notify: install zsh-completions

    # zsh-completions
    - name: install zsh-completions
      shell: git clone https://github.com/zsh-users/zsh-completions ~/.oh-my-zsh/custom/plugins/zsh-completions
      args:
        creates: ~/.oh-my-zsh/custom/plugins/zsh-completions
      notify: setup zsh

    # install fzf configurations
    - name: install fzf configurations
      shell: /usr/local/opt/fzf/install --all --no-fish --64

    # custom fzf command
    - name: custom fzf command
      shell: cp ./dotfzf.commands.zsh ~/.fzf.commands.zsh

    # replace .zshrc.local file
    - name: replace .zshrc.local file
      shell: cp ./dotzshrc.local ~/.zshrc.local

    # neovim
    - name: install dein
      shell: curl -sL https://raw.githubusercontent.com/Shougo/dein.vim/master/bin/installer.sh | sh -s ~/.config/nvim/dein
      notify: install nvim/init.vim

    # solarized dircolor for ls
    - name: install solarized dircolor
      get_url:
        url: https://raw.githubusercontent.com/seebi/dircolors-solarized/master/dircolors.256dark
        dest: ~/.dircolors-solarized

    # tmux
    - name: replace .tmux.conf
      shell: cp ./dottmux.conf ~/.tmux.conf

    # pip
    - name: install get-pip.py
      get_url:
        url: https://bootstrap.pypa.io/get-pip.py
        dest: /tmp/get-pip.py

    # pythonz
    - name: install pythonz
      shell: curl -skL https://raw.github.com/saghul/pythonz/master/pythonz-install | bash
      args:
        creates: ~/.pythonz/

    # Ricty
    - name: install xquartz for Ricty
      homebrew_cask: name=xquartz
    - name: install fontforge for Ricty
      homebrew: name=fontforge
    - name: install Ricty
      homebrew: name=ricty
    - name: copy ttf files
      shell: cp -f $(brew --cellar ricty)/*/share/fonts/Ricty*.ttf ~/Library/Fonts/
      args:
        creates: ~/Library/Fonts/Ricty-Bold.ttf
      notify: run fc-cache

    # terraform
    - name: install zsh-completion for terraform
      get_url:
        url: https://raw.githubusercontent.com/hashicorp/terraform/master/contrib/zsh-completion/_terraform
        dest: /usr/local/share/zsh/site-functions/_terraform
    - name: install zsh-completion for terraform
      get_url:
        url: https://raw.githubusercontent.com/dtan4/terraforming/master/contrib/zsh-completion/_terraforming
        dest: /usr/local/share/zsh/site-functions/_terraforming

    # kubernetes
    - name: install kube-ps1
      get_url:
        url: https://raw.githubusercontent.com/jonmosco/kube-ps1/master/kube-ps1.sh
        dest: /usr/local/bin/kube-ps1.sh

  handlers:
    - name: run fc-cache
      shell: fc-cache -vf
    - name: setup zsh
      script: ./setup_zsh.sh
    - name: install nvim/init.vim
      shell: cp ./nvim/init.vim ~/.config/nvim/init.vim
    - name: install pip
      shell: python /tmp/get-pip.py
